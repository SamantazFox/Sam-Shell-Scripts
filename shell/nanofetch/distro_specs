#!/bin/sh

IFS=$_new_IFS

#
# Distro name
#

# Ubuntu / Debian
if [ -e /etc/lsb-release ]; then
	. /etc/lsb-release
	distro="$DISTRIB_ID $DISTRIB_RELEASE $DISTRIB_CODENAME"

# Fedora / CentOS / Arch Linux / Manjaroo
elif [ -e /etc/os-release ]; then
	. /etc/os-release
	distro="${PRETTY_NAME:-$NAME}"

# RedHat
elif [ -e /etc/redhat-release ]; then distro=$(cat /etc/redhat-release)

# Fallback
else
	distro="Linux generic"
fi


#
# Kernel / Memory / CPU details
#

# Kernel version
kernel="$(uname -m) $(uname -sr)"


# Memory informations
get_mem_info()
{
	mem_total_kib=$1
	mem_avail_kib=$2
}

get_mem_info $(sed -nE '
	s/MemTotal:\s+([0-9]+) kB/\1/p
	s/MemAvailable:\s+([0-9]+) kB/\1/p
' /proc/meminfo)

mem_total_mib=$(( $mem_total_kib / 1024 ))
mem_avail_mib=$(( $mem_avail_kib / 1024 ))

mem_used_kib=$(( $mem_total_kib - $mem_avail_kib ))
mem_used_mib=$(( $mem_used_kib / 1024 ))



# CPU informations
get_cpu_info()
{
	cpu_threads=$1
	cpu_coresps=$2
	cpu_sockets=$3
	cpu_vendor=$4
	cpu_model=$5
	cpu_freq_current=$6
	cpu_max_freq=$7
}

get_cpu_info $(lscpu | sed -nE '
	s/^CPU\(s\):\s+([0-9]+)$/\1/p
	s/^Core\(s\) per socket:\s+([0-9]+)$/\1/p
	s/^Socket\(s\):\s+([0-9]+)$/\1/p
	s/^Vendor ID:\s+([A-Za-z]+)$/\1/p
	/^Model name/ {
		# Strip "APU"/"CPU"/"Processor"
		s/( (APU|CPU|Processor).*)$//
		s/^Model name:\s+(.+)/\1/p
	}
	s/^CPU MHz:\s+([0-9]+).+$/\1/p
	s/^CPU max MHz:\s+([0-9]+).+$/\1/p
')


cpu_cores=$(( $cpu_sockets * $cpu_coresps ))

# Use current F if max F is not available
cpu_freq=${cpu_max_freq:-$cpu_freq_current}

# Format frequency (YYZ -> YYZ MHz / XYYZ -> X.YY Ghz)
if [ ${#cpu_freq} -eq 4 ];
then
	cpu_freq_ghz=$(( $cpu_freq / 1000 ))
	cpu_freq_rem=$(( $cpu_freq - ($cpu_freq_ghz*1000) ))
	cpu_freq="${cpu_freq_ghz}.${cpu_freq_rem} GHz"
else
	cpu_freq="${cpu_freq} MHz"
fi


IFS=$_old_IFS


#
# Other
#

case $SHELL in
	*zsh)  shell=$($SHELL --version | sed -E 's/(\(.*\))//');;
	*bash) shell=$($SHELL --version | sed -E '1s/^(GNU [Bb]ash), version ([0-9.]+).*$/\1 \2/; q');;
	*)     shell="Unknown";;
esac


disks_raw=( $(df -Ph --total --local -x tmpfs -x devtmpfs) )
disks_total=${disks_raw[-5]}
disks_used=${disks_raw[-4]}
disks_avail=${disks_raw[-3]}
